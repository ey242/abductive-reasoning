<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Context & Outcome Rating Task</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --w: 980px; --bg:#f7f7fb; --ink:#111827; --muted:#6b7280; --card:#fff; --br:#e5e7eb; --accent:#374151; --pill:#eef2ff; --pillb:#c7d2fe; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:var(--ink); }
  .wrap { max-width: var(--w); margin: 24px auto 64px; padding: 0 16px; }
  .card { background:var(--card); border:1px solid var(--br); border-radius: 14px; box-shadow: 0 10px 28px rgba(0,0,0,.05); padding: 18px 20px; }
  h1 { margin: 0 0 6px; font-size: 22px; }
  .muted { color: var(--muted); font-size: 14px; }
  .info { background:#f1f5ff; border:1px solid #dbe5ff; border-radius: 12px; padding: 12px 14px; margin: 10px 0 16px; }
  .row { margin: 14px 0; }
  label { font-weight: 600; display:block; margin: 4px 0; }
  input[type="text"], input[type="number"] { width: 280px; padding: 10px 12px; border:1px solid var(--br); border-radius: 10px; font: inherit; }
  .radio-row { display:flex; gap:14px; align-items:center; }
  .pill { display:inline-block; font-size:12px; border-radius:999px; padding:2px 8px; background:var(--pill); border:1px solid var(--pillb); color:#3730a3; }
  .trial { border:1px solid var(--br); border-radius: 14px; padding: 14px; margin: 14px 0; }
  .trial h3 { margin: 0 0 6px; font-size: 18px; }
  blockquote { background:#fafafa; border-left:4px solid #ddd; padding:8px 10px; margin:6px 0 10px; border-radius: 8px; }
  .rating { display:flex; gap:10px; flex-wrap: wrap; margin: 6px 0 8px; }
  .rating label { font-weight: 500; display:flex; align-items:center; gap:6px; }
  textarea { width:100%; min-height:70px; resize: vertical; padding:10px 12px; border:1px solid var(--br); border-radius: 10px; font: inherit; }
  button { background:var(--accent); color:#fff; border:none; border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor: pointer; }
  .ghost { background:#fff; color: var(--accent); border: 1px solid var(--accent); }
  .bar { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap: wrap; }
  .req { color:#b91c1c; font-size: 13px; display:none; margin-top: 6px; }
  .ok { color:#065f46; }
  .warn { color:#92400e; }
  .small { font-size: 13px; color: var(--muted); }
  .sp { height: 10px; }
  .hidden { display:none !important; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .progress { font-size: 14px; color: var(--muted); }
  .foot { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top: 14px; flex-wrap: wrap; }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Context &amp; Outcome Rating Task</h1>

    <!-- SCREEN: WELCOME / DEMOGRAPHICS -->
    <div id="screen-welcome">
      <div class="muted">Please read carefully and complete all trials.</div>
      <div class="info">
        <p><strong>Instructions.</strong> You will see <strong>20 trials</strong>. Each trial shows a <em>context</em> and an <em>outcome</em>. Rate how sensible the outcome is given the context on a <strong>0–10 scale</strong> (0 = does not make sense at all; 10 = completely makes sense).</p>
        <ul>
          <li>If you rate <strong>&lt; 5</strong>, add a brief explanation that links the Context to the Outcome so the writing makes sense.</li>
          <li>You may earn a <strong>$0.01 bonus per trial</strong> if you rate appropriately: <em>commonsense</em> trials are expected to be <strong>≥ 5</strong>; <em>uncommonsense</em> trials are expected to be <strong>&lt; 5</strong>.</li>
          <li>Explanations should be straightforward and minimal, but submissions may be <strong>rejected</strong> if there is insufficient effort.</li>
        </ul>
        <p class="small">Your responses will be shown at the end as JSON (and can be POSTed to a server if configured).</p>
      </div>

      <div class="row">
        <label for="pid">Prolific ID (required)</label>
        <input id="pid" type="text" placeholder="Prolific ID" />
        <div id="pidReq" class="req">Please enter your Prolific ID.</div>
      </div>

      <div class="row">
        <label for="age">Age (required)</label>
        <input id="age" type="number" min="18" max="120" placeholder="18+" />
        <div id="ageReq" class="req">Please enter your age (18+).</div>
      </div>

      <div class="row">
        <label>Gender (required)</label>
        <div class="radio-row">
          <label><input type="radio" name="gender" value="F"> F</label>
          <label><input type="radio" name="gender" value="M"> M</label>
        </div>
        <div id="genderReq" class="req">Please select F or M.</div>
      </div>

      <div class="bar">
        <div class="small">CSV: <span class="mono" id="csvName">abductive-10.csv</span> · <span id="counts" class="small"></span></div>
        <button id="startBtn">Start</button>
      </div>
    </div>

    <!-- SCREEN: TRIAL (one at a time) -->
    <div id="screen-trial" class="hidden">
      <div class="progress" id="progressText">Trial 1 of 20</div>
      <div id="trialHost"></div>
      <div class="foot">
        <div class="small">Rating required. If rating &lt; 5, add a brief explanation (≥ <span id="minChars"></span> chars).</div>
        <div>
          <button id="nextBtn">Next</button>
        </div>
      </div>
    </div>

    <!-- SCREEN: FINISH -->
    <div id="screen-finish" class="hidden">
      <div id="receipt" class="info"></div>
      <div class="row">
        <button id="copyJsonBtn" class="ghost">Copy JSON</button>
      </div>
    </div>
  </div>
</div>

<script>
/* -------- CONFIG (edit these) -------- */
const CONFIG = {
  csvFile: 'abductive-10.csv',              // must be served over http/https
  fixedIds: [                               // exactly 20 source_index values
    0,1,3,4,5,6,7,8,10,11,12,
    14,15,17,18,19,21,23,24,26
  ],
  seed: 42,                                 // reproducible split/order
  submitUrl: '',                            // optional: endpoint to receive JSON (e.g., Apps Script)
  effortMinChars: 5,                        // min explanation length when rating < 5
  bonusCommonsenseMin: 5,                   // commonsense “appropriate” if rating >= this
  bonusUncommonsenseMax: 4                  // uncommonsense “appropriate” if rating <= this
};
/* ------------------------------------- */

function decodeLatin1(uint8){ return new TextDecoder('iso-8859-1').decode(uint8); }
function mulberry32(seed){ let t=seed>>>0; return function(){ t+=0x6D2B79F5; let r=Math.imul(t^t>>>15,1|t); r^=r+Math.imul(r^r>>>7,61|r); return ((r^r>>>14)>>>0)/4294967296; }; }
function norm(s){ return (s??'').toString().trim(); }
function hasText(s){ return norm(s).length>0; }
function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

function indexRows(rows){
  const byId=new Map();
  for(const r of rows){
    const sid=parseInt(norm(r['source_index']),10);
    if(!Number.isFinite(sid)) continue;
    const cs=norm(r['commonsense_context']);
    const ucs=norm(r['uncommonsense_context']);
    const out=norm(r['outcome']);
    if(!hasText(out)) continue;
    if(!hasText(cs) && !hasText(ucs)) continue;
    byId.set(sid,{source_index:sid,commonsense_context:cs,uncommonsense_context:ucs,outcome:out});
  }
  return byId;
}

function selectFixedTrials(byId, ids, seed){
  if(ids.length!==20) throw new Error('CONFIG.fixedIds must contain exactly 20 integers.');
  const rng=mulberry32(seed ?? Math.floor(Math.random()*1e9));
  const avail=ids.filter(i=>byId.has(i));
  if(avail.length!==20) throw new Error('Some fixedIds not found in CSV or invalid.');

  const csPool=avail.filter(i=>hasText(byId.get(i).commonsense_context));
  const ucsPool=avail.filter(i=>hasText(byId.get(i).uncommonsense_context));

  function shuffled(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){const j=Math.floor(rng()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

  const chosen=new Set(); const csChosen=[]; const ucsChosen=[];
  for(const id of shuffled(csPool)){ if(csChosen.length===10) break; if(chosen.has(id)) continue; csChosen.push(id); chosen.add(id); }
  for(const id of shuffled(ucsPool)){ if(ucsChosen.length===10) break; if(chosen.has(id)) continue; ucsChosen.push(id); chosen.add(id); }

  function fill(list,target,prefer){
    const pool=shuffled(avail);
    for(const id of pool){
      if(list.length>=target) break;
      if(chosen.has(id)) continue;
      const row=byId.get(id);
      if(prefer==='cs' && hasText(row.commonsense_context)){ list.push(id); chosen.add(id); }
      if(prefer==='ucs' && hasText(row.uncommonsense_context)){ list.push(id); chosen.add(id); }
    }
  }
  if(csChosen.length<10) fill(csChosen,10,'cs');
  if(ucsChosen.length<10) fill(ucsChosen,10,'ucs');
  if(csChosen.length<10 || ucsChosen.length<10){
    throw new Error('Among fixedIds, not enough contexts to form 10 commonsense and 10 uncommonsense. Replace some IDs or relax the 10/10 rule.');
  }

  const trials=[];
  for(const id of csChosen){ const r=byId.get(id); trials.push({source_index:id,variant:'commonsense',context:r.commonsense_context,outcome:r.outcome}); }
  for(const id of ucsChosen){ const r=byId.get(id); trials.push({source_index:id,variant:'uncommonsense',context:r.uncommonsense_context,outcome:r.outcome}); }

  const order=trials.map((_,i)=>i);
  for(let i=order.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [order[i],order[j]]=[order[j],order[i]]; }
  return order.map(i=>trials[i]);
}

function computeBonusOk(variant, rating){
  return variant==='commonsense' ? (rating>=CONFIG.bonusCommonsenseMin) : (rating<=CONFIG.bonusUncommonsenseMax);
}

/* ---------------- State ---------------- */
const state = {
  byId: null,
  trials: [],
  i: 0,
  participant: { pid:'', age:null, gender:null },
  answers: [],  // [{... per trial ...}]
  trialStartTs: null,      // performance.now() when trial i is shown
  firstRatingTs: null      // performance.now() when first rating is clicked
};

/* --------------- UI helpers --------------- */
function show(id){ document.getElementById(id).classList.remove('hidden'); }
function hide(id){ document.getElementById(id).classList.add('hidden'); }
function setText(id,t){ document.getElementById(id).textContent = t; }

function buildTrialHTML(t, idx){
  return `
    <div class="trial">
      <h3>Trial ${idx+1} <span class="pill">#${t.source_index} · ${t.variant}</span></h3>
      <label>Context</label>
      <blockquote>${escapeHtml(t.context)}</blockquote>
      <label>Outcome</label>
      <blockquote>${escapeHtml(t.outcome)}</blockquote>

      <label>Your rating (0–10)</label>
      <div class="rating" role="radiogroup" aria-label="rating ${idx+1}">
        ${Array.from({length:11},(_,v)=>v).map(v=>`
          <label><input type="radio" name="rating" value="${v}"> ${v}</label>
        `).join('')}
      </div>
      <div id="rateReq" class="req">Please provide a rating.</div>

      <label>Explanation (required if rating &lt; 5)</label>
      <textarea id="explain" placeholder="Add a brief reason if you rated below 5..."></textarea>
      <div id="expReq" class="req">Please add a brief explanation (≥ ${CONFIG.effortMinChars} characters) for ratings below 5.</div>
    </div>
  `;
}

function renderCurrentTrial(){
  const t = state.trials[state.i];
  setText('progressText', `Trial ${state.i+1} of ${state.trials.length}`);
  document.getElementById('trialHost').innerHTML = buildTrialHTML(t, state.i);
  setText('minChars', CONFIG.effortMinChars.toString());

  // reset timers for this trial
  state.trialStartTs = performance.now();
  state.firstRatingTs = null;

  // rating change handlers
  document.querySelectorAll('input[name="rating"]').forEach(r => {
    r.addEventListener('change', () => {
      document.getElementById('rateReq').style.display = 'none';
      if (state.firstRatingTs === null) {
        state.firstRatingTs = performance.now();  // reading time captured here
      }
      const val = parseInt(r.value,10);
      const exp = document.getElementById('explain').value.trim();
      if (val < 5 && exp.length < CONFIG.effortMinChars) {
        document.getElementById('expReq').style.display = 'block';
      } else {
        document.getElementById('expReq').style.display = 'none';
      }
    });
  });

  // text input live validation when needed
  document.getElementById('explain').addEventListener('input', () => {
    const checked = document.querySelector('input[name="rating"]:checked');
    const val = checked ? parseInt(checked.value,10) : null;
    if (val !== null && val < 5) {
      const ok = document.getElementById('explain').value.trim().length >= CONFIG.effortMinChars;
      document.getElementById('expReq').style.display = ok ? 'none' : 'block';
    }
  });
}

/* --------------- Flow --------------- */
async function loadCSV(){
  document.getElementById('csvName').textContent = CONFIG.csvFile;
  try{
    const res = await fetch(CONFIG.csvFile);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = decodeLatin1(new Uint8Array(await res.arrayBuffer()));
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    state.byId = indexRows(parsed.data);
    setText('counts', `(${state.byId.size} usable rows)`);
  }catch(err){
    setText('counts', `Failed to load CSV (${err.message}). Ensure this page is served over http/https and the CSV sits next to it.`);
    throw err;
  }
}

function validateWelcome(){
  const pid = document.getElementById('pid').value.trim();
  const ageVal = document.getElementById('age').value.trim();
  const genderEl = document.querySelector('input[name="gender"]:checked');

  let ok = true;
  document.getElementById('pidReq').style.display = pid ? 'none' : 'block'; if (!pid) ok = false;
  const ageNum = parseInt(ageVal,10);
  const ageOk = Number.isFinite(ageNum) && ageNum >= 18 && ageNum <= 120;
  document.getElementById('ageReq').style.display = ageOk ? 'none' : 'block'; if (!ageOk) ok = false;
  document.getElementById('genderReq').style.display = genderEl ? 'none' : 'block'; if (!genderEl) ok = false;

  if (ok){
    state.participant = { pid, age: ageNum, gender: genderEl.value };
  }
  return ok;
}

function nextTrialOrFinish(){
  // gather current trial response
  const checked = document.querySelector('input[name="rating"]:checked');
  if (!checked){
    document.getElementById('rateReq').style.display = 'block';
    return;
  }
  const rating = parseInt(checked.value,10);
  const explanation = document.getElementById('explain').value.trim();
  if (rating < 5 && explanation.length < CONFIG.effortMinChars){
    document.getElementById('expReq').style.display = 'block';
    return;
  }

  const t = state.trials[state.i];
  const readMs = state.firstRatingTs === null ? null : Math.round(state.firstRatingTs - state.trialStartTs);
  const appropriate = computeBonusOk(t.variant, rating) ? 1 : 0;

  state.answers.push({
    index_displayed: state.i + 1,
    source_index: t.source_index,
    variant: t.variant,
    rating,
    explanation,
    read_ms_until_first_rating: readMs,
    appropriate_bonus: appropriate,
    context_shown: t.context,
    outcome_shown: t.outcome
  });

  // advance
  state.i += 1;
  if (state.i < state.trials.length){
    renderCurrentTrial();
  } else {
    finish();
  }
}

async function finish(){
  hide('screen-trial');
  show('screen-finish');

  const bonusCount = state.answers.reduce((s,a)=>s + (a.appropriate_bonus?1:0), 0);
  const payload = {
    participant_id: state.participant.pid,
    age: state.participant.age,
    gender: state.participant.gender,
    submitted_at_utc: new Date().toISOString(),
    n_trials: state.trials.length,
    bonus_cents: bonusCount,
    trials: state.answers
  };

  let msg = `<strong>Thanks!</strong> You completed ${state.trials.length} trials. Potential bonus: <strong>$${(bonusCount*0.01).toFixed(2)}</strong>.`;
  if (CONFIG.submitUrl){
    try{
      const resp = await fetch(CONFIG.submitUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!resp.ok) throw new Error(`Server responded ${resp.status}`);
      msg += ` <span class="ok small">Your responses were submitted successfully.</span>`;
    }catch(e){
      msg += ` <span class="warn small">Could not reach the server (${e.message}). You can copy JSON below and send it manually.</span>`;
      console.error(e);
    }
  } else {
    msg += ` <span class="small">No server configured. Click “Copy JSON” to save your responses.</span>`;
  }
  document.getElementById('receipt').innerHTML = `<div class="info">${msg}</div>`;

  document.getElementById('copyJsonBtn').onclick = ()=>{
    const json = JSON.stringify(payload,null,2);
    navigator.clipboard.writeText(json).then(()=>{
      const b=document.getElementById('copyJsonBtn'); b.textContent='JSON copied!'; setTimeout(()=>b.textContent='Copy JSON',1800);
    });
  };
}

/* --------------- Boot --------------- */
(async function boot(){
  await loadCSV();

  // build trials from fixedIds now so start is instant
  try{
    state.trials = selectFixedTrials(state.byId, CONFIG.fixedIds, CONFIG.seed);
  }catch(e){
    // show error on welcome screen
    const c = document.getElementById('counts');
    c.textContent = e.message;
    document.getElementById('startBtn').disabled = true;
    return;
  }

  document.getElementById('startBtn').addEventListener('click', ()=>{
    if (!validateWelcome()) return;
    hide('screen-welcome');
    show('screen-trial');
    renderCurrentTrial();
  });

  document.getElementById('nextBtn').addEventListener('click', nextTrialOrFinish);
})();
</script>
</body>
</html>
