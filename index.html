<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Context & Outcome Rating Task</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --w: 980px; --bg:#f7f7fb; --ink:#111827; --muted:#6b7280; --card:#fff; --br:#e5e7eb; --accent:#374151; --pill:#eef2ff; --pillb:#c7d2fe; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:var(--ink); }
  .wrap { max-width: var(--w); margin: 24px auto 64px; padding: 0 16px; }
  .card { background:var(--card); border:1px solid var(--br); border-radius: 14px; box-shadow: 0 10px 28px rgba(0,0,0,.05); padding: 18px 20px; }
  h1 { margin: 0 0 6px; font-size: 22px; }
  .muted { color: var(--muted); font-size: 14px; }
  .info { background:#f1f5ff; border:1px solid #dbe5ff; border-radius: 12px; padding: 12px 14px; margin: 10px 0 16px; }
  .row { margin: 14px 0; }
  label { font-weight: 600; display:block; margin: 4px 0; }
  input[type="text"], input[type="number"] { width: 280px; padding: 10px 12px; border:1px solid var(--br); border-radius: 10px; font: inherit; }
  .radio-row { display:flex; gap:14px; align-items:center; }
  .trial { border:1px solid var(--br); border-radius: 14px; padding: 14px; margin: 14px 0; }
  blockquote { background:#fafafa; border-left:4px solid #ddd; padding:8px 10px; margin:6px 0 10px; border-radius: 8px; }
  .rating { display:flex; gap:10px; flex-wrap: wrap; margin: 6px 0 8px; }
  .rating label { font-weight: 500; display:flex; align-items:center; gap:6px; }
  textarea { width:100%; min-height:70px; resize: vertical; padding:10px 12px; border:1px solid var(--br); border-radius: 10px; font: inherit; }
  button { background:var(--accent); color:#fff; border:none; border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor: pointer; }
  .req { color:#b91c1c; font-size: 13px; display:none; margin-top: 6px; }
  .small { font-size: 13px; color: var(--muted); }
  .progress { font-size: 14px; color: var(--muted); }
  .hidden { display:none !important; }
  .foot { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top: 14px; flex-wrap: wrap; }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Context &amp; Outcome Rating Task</h1>

    <!-- SCREEN: WELCOME / DEMOGRAPHICS -->
    <div id="screen-welcome">
      <div class="muted">Please read carefully and complete all trials.</div>
      <div class="info">
        <p><strong>Instructions.</strong> You will see <strong>20 trials</strong>. Each trial shows a <em>context</em> and an <em>outcome</em>. Rate how sensible the outcome is given the context on a <strong>0–10 scale</strong> (0 = does not make sense at all; 10 = completely makes sense).</p>
        <ul>
          <li>If you rate <strong>&lt; 5</strong>, add a brief explanation that links the Context to the Outcome so the writing makes sense.</li>
          <li>You may earn a <strong>$0.01 bonus per trial</strong> if you rate appropriately: <em>commonsense</em> trials are expected to be <strong>≥ 5</strong>; <em>uncommonsense</em> trials are expected to be <strong>&lt; 5</strong>.</li>
          <li>Explanations should be straightforward and minimal, but submissions may be <strong>rejected</strong> if there is insufficient effort.</li>
        </ul>
      </div>

      <div class="row">
        <label for="pid">Prolific ID (required)</label>
        <input id="pid" type="text" placeholder="Prolific ID" />
        <div id="pidReq" class="req">Please enter your Prolific ID.</div>
      </div>

      <div class="row">
        <label for="age">Age (required)</label>
        <input id="age" type="number" min="18" max="120" placeholder="18+" />
        <div id="ageReq" class="req">Please enter your age (18+).</div>
      </div>

      <div class="row">
        <label>Gender (required)</label>
        <div class="radio-row">
          <label><input type="radio" name="gender" value="F"> F</label>
          <label><input type="radio" name="gender" value="M"> M</label>
        </div>
        <div id="genderReq" class="req">Please select F or M.</div>
      </div>

      <div class="row" style="display:flex;justify-content:flex-end;">
        <button id="startBtn">Start</button>
      </div>
    </div>

    <!-- SCREEN: TRIAL (one at a time) -->
    <div id="screen-trial" class="hidden">
      <div class="progress" id="progressText">Trial 1 of 20</div>
      <div id="trialHost"></div>
      <div class="foot">
        <div class="small">Rating required. If rating &lt; 5, add a brief explanation (≥ <span id="minChars"></span> characters).</div>
        <div><button id="nextBtn">Next</button></div>
      </div>
    </div>

    <!-- SCREEN: FINISH -->
    <div id="screen-finish" class="hidden">
      <div id="receipt" class="info"></div>
      <div class="row"><button id="copyJsonBtn">Copy JSON</button></div>
    </div>
  </div>
</div>

<script>
/* -------- CONFIG (edit these) -------- */
const CONFIG = {
  csvFile: 'abductive-10.csv',              // must be served over http/https
  fixedIds: [                               // exactly 20 source_index values
    0,1,3,4,5,6,7,8,10,11,12,
    14,15,17,18,19,21,23,24,26
  ],
  seed: 42,                                 // default seed (overridden by ?seed=)
  flipVariants: false,                      // default flip (overridden by ?flip=1)
  submitUrl: '',                            // optional endpoint to POST JSON
  effortMinChars: 30,                       // min explanation length when rating < 5
  bonusCommonsenseMin: 5,                   // CS “appropriate” if rating >= this
  bonusUncommonsenseMax: 4                  // UCS “appropriate” if rating <= this
};
/* ------------------------------------- */

function decodeLatin1(uint8){ return new TextDecoder('iso-8859-1').decode(uint8); }
function norm(s){ return (s??'').toString().trim(); }
function hasText(s){ return norm(s).length>0; }
function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function getParamInt(name){ const v=new URLSearchParams(location.search).get(name); const n=parseInt(v,10); return Number.isFinite(n)?n:null; }
function getParamBool(name){ const v=new URLSearchParams(location.search).get(name); if(v===null) return null; return /^(1|true|yes)$/i.test(v); }

/* ---------- CSV helpers ---------- */
function indexRows(rows){
  const byId=new Map();
  for(const r of rows){
    const sid=parseInt(norm(r['source_index']),10);
    if(!Number.isFinite(sid)) continue;
    const cs=norm(r['commonsense_context']);
    const ucs=norm(r['uncommonsense_context']);
    const out=norm(r['outcome']);
    if(!hasText(out)) continue;
    if(!hasText(cs) && !hasText(ucs)) continue;
    byId.set(sid,{source_index:sid,commonsense_context:cs,uncommonsense_context:ucs,outcome:out});
  }
  return byId;
}

/* ---------- Deterministic variant rule (supports flip) ---------- */
function hashBool(seed, id){
  // simple 32-bit mix; returns true/false deterministically per (seed,id)
  let x = (seed ^ (id * 0x45d9f3b)) >>> 0;
  x = (x ^ (x >>> 15)) * 0x45d9f3b >>> 0;
  x = (x ^ (x >>> 15)) >>> 0;
  return (x & 1) === 1; // true/false
}

function assignTrialsDeterministic(byId, ids, seed, flip){
  if(ids.length!==20) throw new Error('CONFIG.fixedIds must contain exactly 20 integers.');
  const avail = ids.filter(i=>byId.has(i));
  if(avail.length!==20) throw new Error('Some fixedIds not found in CSV or invalid.');

  // initial assignment
  const items = avail.map(id=>{
    const row = byId.get(id);
    const hasCS = hasText(row.commonsense_context);
    const hasUCS = hasText(row.uncommonsense_context);
    let variant;
    if (hasCS && hasUCS){
      const bit = hashBool(seed, id) ^ (flip?1:0);
      variant = bit ? 'uncommonsense' : 'commonsense';
    } else if (hasCS){ variant = 'commonsense'; }
    else if (hasUCS){ variant = 'uncommonsense'; }
    else { throw new Error(`ID ${id} has no usable context.`); }
    return { id, row, variant, hasBoth: hasCS && hasUCS };
  });

  // rebalance to exactly 10 CS / 10 UCS using only items that have both variants
  let cs = items.filter(x=>x.variant==='commonsense').length;
  let ucs = 20 - cs;
  const needCS = 10 - cs;   // positive => need to flip some UCS->CS
  const needUCS = 10 - ucs; // positive => need to flip some CS->UCS

  function flipSome(fromVariant, toVariant, count){
    if(count<=0) return true;
    // deterministic order: ascending id
    const pool = items.filter(x=>x.variant===fromVariant && x.hasBoth).sort((a,b)=>a.id-b.id);
    for(let i=0;i<pool.length && count>0;i++){
      pool[i].variant = toVariant;
      count--;
    }
    return count===0;
  }

  if (needCS > 0 && !flipSome('uncommonsense','commonsense', needCS)) {
    throw new Error('Not enough dual-variant trials among fixedIds to reach 10 commonsense after flipping. Replace some IDs.');
  }
  if (needUCS > 0 && !flipSome('commonsense','uncommonsense', needUCS)) {
    throw new Error('Not enough dual-variant trials among fixedIds to reach 10 uncommonsense after flipping. Replace some IDs.');
  }

  // build trial objects, then shuffle presentation order deterministically
  const trials = items.map(x=>{
    const ctx = x.variant==='commonsense' ? x.row.commonsense_context : x.row.uncommonsense_context;
    return { source_index: x.id, variant: x.variant, context: ctx, outcome: x.row.outcome };
  });

  // shuffle order by seed (stable)
  function rng(seed0){ let t=seed0>>>0; return ()=>{ t+=0x6D2B79F5; let r=Math.imul(t^t>>>15,1|t); r^=r+Math.imul(r^r>>>7,61|r); return ((r^r>>>14)>>>0)/4294967296; }; }
  const R = rng(seed ^ (flip?0x9E3779B1:0)); // different order when flipped
  for(let i=trials.length-1;i>0;i--){ const j=Math.floor(R()*(i+1)); [trials[i],trials[j]]=[trials[j],trials[i]]; }
  return trials;
}

function computeBonusOk(variant, rating){
  return variant==='commonsense' ? (rating>=CONFIG.bonusCommonsenseMin) : (rating<=CONFIG.bonusUncommonsenseMax);
}

/* ---------------- State ---------------- */
const state = {
  byId: null,
  trials: [],
  i: 0,
  participant: { pid:'', age:null, gender:null },
  answers: [],
  trialStartTs: null,
  firstRatingTs: null
};

/* --------------- UI helpers --------------- */
function show(id){ document.getElementById(id).classList.remove('hidden'); }
function hide(id){ document.getElementById(id).classList.add('hidden'); }
function setText(id,t){ document.getElementById(id).textContent = t; }

function buildTrialHTML(/*t, idx*/){
  // No #ID or variant shown to participants
  return `
    <div class="trial">
      <label>Context</label>
      <blockquote id="ctx"></blockquote>
      <label>Outcome</label>
      <blockquote id="out"></blockquote>

      <label>Your rating (0–10)</label>
      <div class="rating" role="radiogroup" aria-label="rating">
        ${Array.from({length:11},(_,v)=>v).map(v=>`<label><input type="radio" name="rating" value="${v}"> ${v}</label>`).join('')}
      </div>
      <div id="rateReq" class="req">Please provide a rating.</div>

      <label>Explanation (required if rating &lt; 5)</label>
      <textarea id="explain" placeholder="Add a brief reason if you rated below 5..."></textarea>
      <div id="expReq" class="req">Please add a brief explanation (≥ <span id="minChars"></span> characters) for ratings below 5.</div>
    </div>
  `;
}

function renderCurrentTrial(){
  const t = state.trials[state.i];
  setText('progressText', `Trial ${state.i+1} of ${state.trials.length}`);
  const host = document.getElementById('trialHost');
  host.innerHTML = buildTrialHTML();
  document.getElementById('ctx').textContent = t.context;
  document.getElementById('out').textContent = t.outcome;
  setText('minChars', CONFIG.effortMinChars.toString());

  state.trialStartTs = performance.now();
  state.firstRatingTs = null;

  document.querySelectorAll('input[name="rating"]').forEach(r => {
    r.addEventListener('change', () => {
      document.getElementById('rateReq').style.display = 'none';
      if (state.firstRatingTs === null) state.firstRatingTs = performance.now();
      const val = parseInt(r.value,10);
      const exp = document.getElementById('explain').value.trim();
      document.getElementById('expReq').style.display = (val < 5 && exp.length < CONFIG.effortMinChars) ? 'block' : 'none';
    });
  });

  document.getElementById('explain').addEventListener('input', () => {
    const checked = document.querySelector('input[name="rating"]:checked');
    const val = checked ? parseInt(checked.value,10) : null;
    if (val !== null && val < 5) {
      const ok = document.getElementById('explain').value.trim().length >= CONFIG.effortMinChars;
      document.getElementById('expReq').style.display = ok ? 'none' : 'block';
    }
  });
}

/* --------------- Flow --------------- */
async function loadCSV(){
  const res = await fetch(CONFIG.csvFile);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = decodeLatin1(new Uint8Array(await res.arrayBuffer()));
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
  state.byId = indexRows(parsed.data);
}

function validateWelcome(){
  const pid = document.getElementById('pid').value.trim();
  const ageVal = document.getElementById('age').value.trim();
  const genderEl = document.querySelector('input[name="gender"]:checked');

  let ok = true;
  document.getElementById('pidReq').style.display = pid ? 'none' : 'block'; if (!pid) ok = false;
  const ageNum = parseInt(ageVal,10);
  const ageOk = Number.isFinite(ageNum) && ageNum >= 18 && ageNum <= 120;
  document.getElementById('ageReq').style.display = ageOk ? 'none' : 'block'; if (!ageOk) ok = false;
  document.getElementById('genderReq').style.display = genderEl ? 'none' : 'block'; if (!genderEl) ok = false;

  if (ok){
    state.participant = { pid, age: ageNum, gender: genderEl.value };
  }
  return ok;
}

function nextTrialOrFinish(){
  const checked = document.querySelector('input[name="rating"]:checked');
  if (!checked){ document.getElementById('rateReq').style.display = 'block'; return; }
  const rating = parseInt(checked.value,10);
  const explanation = document.getElementById('explain').value.trim();
  if (rating < 5 && explanation.length < CONFIG.effortMinChars){
    document.getElementById('expReq').style.display = 'block';
    return;
  }

  const t = state.trials[state.i];
  const readMs = state.firstRatingTs === null ? null : Math.round(state.firstRatingTs - state.trialStartTs);
  const appropriate = computeBonusOk(t.variant, rating) ? 1 : 0;

  state.answers.push({
    index_displayed: state.i + 1,
    source_index: t.source_index,
    variant: t.variant,                    // stored, not shown to the participant
    rating,
    explanation,
    read_ms_until_first_rating: readMs,
    appropriate_bonus: appropriate,
    context_shown: t.context,
    outcome_shown: t.outcome
  });

  state.i += 1;
  if (state.i < state.trials.length){
    renderCurrentTrial();
  } else {
    finish();
  }
}

async function finish(){
  hide('screen-trial'); show('screen-finish');
  const bonusCount = state.answers.reduce((s,a)=>s + (a.appropriate_bonus?1:0), 0);
  const payload = {
    participant_id: state.participant.pid,
    age: state.participant.age,
    gender: state.participant.gender,
    submitted_at_utc: new Date().toISOString(),
    n_trials: state.trials.length,
    bonus_cents: bonusCount,
    trials: state.answers
  };

  let msg = `<strong>Thanks!</strong> You completed ${state.trials.length} trials. Potential bonus: <strong>$${(bonusCount*0.01).toFixed(2)}</strong>.`;
  if (CONFIG.submitUrl){
    try{
      const resp = await fetch(CONFIG.submitUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!resp.ok) throw new Error(`Server responded ${resp.status}`);
      msg += ` <span class="small" style="color:#065f46">Submitted successfully.</span>`;
    }catch(e){
      msg += ` <span class="small" style="color:#92400e">Could not reach the server. Copy JSON below and send it manually.</span>`;
      console.error(e);
    }
  } else {
    msg += ` <span class="small">No server configured. Click “Copy JSON” to save your responses.</span>`;
  }
  document.getElementById('receipt').innerHTML = `<div class="info">${msg}</div>`;
  document.getElementById('copyJsonBtn').onclick = ()=>{
    const json = JSON.stringify(payload,null,2);
    navigator.clipboard.writeText(json).then(()=>{
      const b=document.getElementById('copyJsonBtn'); b.textContent='JSON copied!'; setTimeout(()=>b.textContent='Copy JSON',1800);
    });
  };
}

/* --------------- Boot --------------- */
(async function boot(){
  try { await loadCSV(); } catch(e){
    alert('Failed to load CSV. Serve this page over http/https and place abductive-10.csv next to it.'); throw e;
  }

  // Read URL overrides
  const urlSeed = getParamInt('seed');
  const urlFlip = getParamBool('flip');
  const seed = (urlSeed ?? CONFIG.seed) >>> 0;
  const flip = (urlFlip ?? CONFIG.flipVariants) === true;

  // Build trials deterministically from fixed IDs
  try{
    state.trials = assignTrialsDeterministic(state.byId, CONFIG.fixedIds, seed, flip);
  }catch(e){
    document.getElementById('startBtn').disabled = true;
    alert(e.message);
    throw e;
  }

  document.getElementById('startBtn').addEventListener('click', ()=>{
    if (!validateWelcome()) return;
    hide('screen-welcome'); show('screen-trial'); renderCurrentTrial();
  });
  document.getElementById('nextBtn').addEventListener('click', nextTrialOrFinish);
})();
</script>
</body>
</html>
